{% from 'backend/files/main/lib.sls' import iterateSettingsFlat with context %}

ktor {
  deployment {
    port = 9090
  }

  application {
    modules = [com.linktime.ktorbase.ApplicationKt.main]
    secret = ${APPLICATION_SECRET}
  }
}

app {
{{ iterateSettingsFlat(pillar.modules.backend.config.app) }}
}

{% if 'jira' in pillar.modules.backend.gateways %}
jira {
  baseUrl = ${JIRA_BASE_URL}
  username = ${JIRA_USERNAME}
  password = ${JIRA_PASSWORD}
  projectKey = ${JIRA_PROJECT_KEY}
  issueTypeName = ${JIRA_ISSUE_TYPE_NAME}
  customFieldName {
    service = "Service"
    service = ${?JIRA_CUSTOM_FIELD_NAME_SERVICE}
    eventId = "Event ID"
    eventId = ${?JIRA_CUSTOM_FIELD_NAME_EVENT_ID}
  }
  workflow {
    statusName {
      closed = "Closed"
      closed = ${?JIRA_WORKFLOW_STATUS_NAME_CLOSED}
    }
    transitionName {
      close = "Done"
      close = ${?JIRA_WORKFLOW_TRANSITION_NAME_CLOSE}
      reopenClosed = "Reopen"
      reopenClosed = ${?JIRA_WORKFLOW_TRANSITION_NAME_REOPEN_CLOSED}
    }
  }
}
{% endif%}

{% if 'insight' in pillar.modules.backend.gateways %}
insight {
  schemaId = ${INSIGHT_SCHEMA_ID}
}
{% endif%}

{% if 'confluence' in pillar.modules.backend.gateways %}
confluence {
  baseUrl = ${CONFLUENCE_BASE_URL}
  username = ${CONFLUENCE_USERNAME}
  password = ${CONFLUENCE_PASSWORD}
  kb {
    spaceKey = ${CONFLUENCE_KB_SPACE_KEY}
    homePageId = ${CONFLUENCE_KB_HOME_PAGE_ID}
    searchExcludeLabels = []
    searchExcludeLabels = [${?CONFLUENCE_KB_SEARCH_EXCLUDE_LABELS}]
    excerptWordLimit = 12
    excerptWordLimit = ${?CONFLUENCE_KB_EXCERPT_WORD_LIMIT}
    page.id {
      welcome = ${CONFLUENCE_KB_PAGE_ID_WELCOME}
    }
  }
}
{% endif%}

{% if pillar.modules.backend.ktor.server.features.saml.selected %}
include "saml.conf"
{% endif%}

{% if pillar.modules.backend.ktor.server.features.sessions.selected %}
include "session.conf"
{% endif%}
